#分布式事务及CAP和BASE理论

##分布式事务
分布式事务是指事务的各种参与者分别位于分布式系统的不同节点之上。通常一个分布式事务
会涉及对多个数据源或者业务系统的操作。  

经典的分布式事务是跨行转账业务，一个银行做取款操作，一个银行做存款操作。如果说取款
操作顺利做完了，但是存款操作异常导致钱未加上去，那么就必须回滚取款操作，如果不能回
滚取款的事务，将会导致转账的钱给丢失了。  

一个分布式事务可以看作是偶多个分布式的操作序列组成，例如上面例子中的取款操作和存款
操作，通常可以把这一些列的分布式的操作序列成为子事务。因此，分布式事务也可以被定义
为一种嵌套类型的事务，同时也就具有了ACID事务特性。由于在分布式事务中，各个子事务的
执行是分布式的，因此要实现一种能够保证ACID特性的分布式事务处理系统还是很复杂的。

##CAP理论
CAP理论是说一个分布式系统不可能同时满足一致性（C：Consistency）、可用性（A：Availability）
和分区容错性（P：Partition tolerance）这三个基本需求，最多只能同时满足其中两项。

###一致性
单节点事务的ACID属性中的一致性是指单个数据库的数据一致性，而在分布式环境中，一致性
是指在多个副本之间是否能能够保证数据一致性。比如说对第一个节点的数据进行了更新操作
并且操作成功，却没有成功更新第二个节点上的数据，于是在第二个节点上读取数据时，就获取
到了老数据，这就是分布式环境中的数据不一致情况。如果在分布式系统中，能够做到针对一个
数据项的更新操作执行成功后，所有的用户都可以读取到最新的值，那么该系统就被任务具有强
一致性。

###可用性
系统可用性一般是说系统一直处于可用的状态，并且在规定的时间内可以得到正常的响应。

###分区容错性
网络分区是指在分布式系统中，不同的节点处于不同的子网络中，可能因为一些特殊原因导致这些
子网络不能够相互正常通讯了，但是每个自网络内部还是正常可以通讯，这样就像是将一个大的网
络环境切割成了几个独立的小网络环境，这就是网络分区故障。  

网络分区故障是肯定会发生的，分布式系统就需要在发生网络分区故障时仍然可以正常的对外提供
满足一致性和可用性的服务。

####CAP思考：
1. 既然是分布式环境，那网络分区故障是肯定会发生的，如果不想因为网络故障发生而影响系统，
那就只能将所有节点都放在一个单点网络中，那其实就不太是真正意义上的分布式系统了，所以说
P是必须要考虑处理的。

2. 考虑一致性问题，客户端向1号节点写入了数据，然后1号节点通知2号节点也写入数据，然后
两个节点的数据就达到了一致性。
    - 1号节点在本地写成功既代表成功，然后立即返回客户端响应成功，再向2号节点发起数据同步，
    这种情况下就会产生数据不一致的问题了，可能客户端收到成功后的响应然后再去2号节点查询数据
    时，1号节点的同步请求还未到达2号节点，这时就产生了数据不一致。
    
    - 如果说像关系型数据库采用的2PC协议来完成呢？两个参与者数据库在阶段一都记录了Undo日志
    并且开启了事务，这时候所有的客户端从两个数据库中都读取的是老的数据值，这时是一致的，然后
    阶段二时，协调者向两个参与者数据库发送commit请求，两个数据库可不一定同时收到请求同时执行
    commit呀，如果说1号库先收到了commit并且执行了，这时2号还未执行，在这一个时间点上，两个
    节点的数据也是不一致的吧。如果说分布式环境中N个节点要在任何一个时间点数据都是一致的，那么
    N只能等于1。所以后续BASE理论就将一致性分了几个等级来看待。

3. 可用性的思考，不同的系统或者说是同一个系统不同的功能模块，可用性的标准是不一样的。比如
说查询余额的功能，一两秒能给出正确的响应，那么用户是可以接受的，可以说可用性合格。再比如一
个数据统计分析功能，分析五年内的数据并生成报表文件下载，这时如果说给个进度条30秒内可以正常
完成，用户也是可以接受的，可用性也是有的。所以说可用性不能说是一概而论的。

4. 为什么说分布式环境中，最多只能同时满足CAP中的两项呢？根据1的描述知道P一定要满足，那C和A
不能同时满足吗？说到zk就是说满足了CP，那zk就没有A可用性可言？那zk还能用不；说到eureka就是
满足了AP，难道eureka中的数据就没有一致性了吗？
    - 说的同时最多满足两项是在发生网络分区故障的时候，如果是正常的情况下，zk可以满足CAP三项。
    发生网络故障时，zk会在重新选举leader的过程中为了保持一致性停止对外服务，eureka是利用自
    身的保护机制禁止大面积将租约过期剔除，有限保证可用性。
    - 即使是在发生网络分区故障时，也不一定说是一个系统就固定的倾向于C或者A，比如说一个系统，
    在发生网络分区时，可以部分功能倾向于可用性，比如说查看商品信息；但是为了保证一致性，下单
    购买功能可以暂时不可用。
    
##BASE理论

BASE理论是 Basically Available（基本可用）、Soft state（软状态）、Eventually consistent
（最终一致性）三个短语的缩写。  
BASE理论是对CAP中一致性和可用性权衡的结果，是基于CAP理论逐步演化而来的，其核心思想是即使无法
做到强一致性，但每个应用都可以根据自身的业务特定，采用合适的方式来使系统达到最终一致性。

###基本可用
指分布式系统在出现故障的时候，允许损失部分可用性，但不等于说系统不可使用。比如说突然部分节点无法
服务，整个系统的服务能力下降了，可以选择vip用户正常使用，非vip用户引导到一个降级页面。

###软状态
是指允许系统中的数据存在中间状态，并任务该中间状态的存在不会影响系统的整体可用性，既允许系统在
不同节点的数据副本之间进行数据同步的过程存在延时。

###最终一致性
系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态，而不是说要实施保证系统
数据的强一致性。最终一致性分为一下五种类型：

1. 因果一致性（Causal consistency）：进程A在更新完某个数据后通知了进程B，那么进程B之后对该
数据项的访问都应该能够获取到进程A更新后的最新值，并且如果进程B要对该数据项进行更新操作的话，务必
基于A更新后的最新值，不能发生丢失更新的情况。但是与A无因果关系的进程C的数据访问则无此限制。

2. 读己之所写（Read your writes）：根据名字也可以看出意思，某个进程自己总能够访问到自己先前
更新过的最新值。

3. 会话一致性（Session consistency）：保证在同一个有效地会话中实现“读己之所写”的一致性，也就
是说，执行更新操作之后，客户端能够在同一个会话中始终读取到该数据项的最新值。

4. 单调读一致性（Monotonic read consistency）：指如果一个进程从系统中读取出一个数据项的某个
值后，那么系统归于该进程后续的任何数据访问都不应该返回更旧的值。

5. 单调写一致性（Monotonic write consistency）：指一个系统能够保证来自同一个进程的写操作被
顺序执行。